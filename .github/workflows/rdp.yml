name: RDP-Windows-10

on:
  workflow_dispatch:
    inputs:
      rdp_username:
        description: 'اسم المستخدم للوصول إلى RDP (الافتراضي: RDP)'
        required: false
        default: 'RDP'
      rdp_password:
        description: 'كلمة المرور للوصول إلى RDP (اتركها فارغة لإنشاء كلمة مرور عشوائية قوية)'
        required: false
        default: 'Admin_000'
      tailscale_hostname_prefix:
        description: 'بادئة لاسم مضيف Tailscale'
        required: false
        default: 'win10-rdp'
      session_duration:
        description: 'مدة التشغيل بالساعات (القصوى 24 ساعة)'
        required: false
        default: '6'
        type: choice
        options:
          - '1'
          - '2'
          - '4'
          - '6'
          - '12'
          - '24'

jobs:
  secure-rdp-session:
    runs-on: windows-2019  # Windows Server 2019 (أقرب لـ Windows 10)
    timeout-minutes: ${{ fromJSON(github.event.inputs.session_duration) * 60 }}

    steps:
      - name: Configure Windows 10 RDP Settings
        shell: pwsh
        run: |
          Write-Host "Configuring Windows 10 RDP Settings..."
          
          # تمكين Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force

          # تفعيل NLA
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 1 -Force

          # Windows 10 إعدادات خاصة بـ
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services' `
                           -Name "fPromptForPassword" -Value 0 -Force -ErrorAction SilentlyContinue

          # تعطيل Windows Defender Firewall مؤقتاً لتجنب المشاكل
          Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False -ErrorAction SilentlyContinue

          # فتح منفذ RDP
          New-NetFirewallRule -DisplayName "RDP-Win10" `
                              -Direction Inbound `
                              -Protocol TCP `
                              -LocalPort 3389 `
                              -Action Allow `
                              -ErrorAction SilentlyContinue

          # تمكين RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          
          Restart-Service TermService -Force

      - name: Create RDP User Account
        id: create_user
        shell: pwsh
        run: |
          $username = "${{ github.event.inputs.rdp_username }}"
          $inputPassword = "${{ github.event.inputs.rdp_password }}"
          
          if ($inputPassword -eq "Admin_000" -or $inputPassword -eq "") {
              $password = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 12 | % {[char]$_})
          } else {
              $password = $inputPassword
          }
          
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          # حذف المستخدم إذا كان موجوداً
          Remove-LocalUser -Name $username -ErrorAction SilentlyContinue
          
          # إنشاء مستخدم جديد
          New-LocalUser -Name $username -Password $securePass -FullName "RDP User" -Description "GitHub RDP User"
          
          # إضافة إلى المجموعات
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          
          # تعطيل انتهاء صلاحية الحساب
          Set-LocalUser -Name $username -PasswordNeverExpires $true -AccountNeverExpires
          
          echo "rdp_password=$password" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding UTF8

      - name: Install Tailscale for Windows 10
        shell: pwsh
        run: |
          Write-Host "Installing Tailscale for Windows 10..."
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-amd64.msi"
          $installer = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $url -OutFile $installer
          Start-Process msiexec.exe -Wait -ArgumentList "/i", "`"$installer`"", "/quiet", "/norestart"
          Remove-Item $installer -Force

      - name: Connect to Tailscale
        id: tailscale
        shell: pwsh
        run: |
          $hostname = "${{ github.event.inputs.tailscale_hostname_prefix }}-$env:GITHUB_RUN_ID"
          
          if (-not "${{ secrets.TAILSCALE_AUTH_KEY }}") {
              Write-Error "❌ TAILSCALE_AUTH_KEY missing!"
              exit 1
          }
          
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up `
            --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" `
            --hostname="$hostname" `
            --accept-routes `
            --accept-dns
          
          # الحصول على IP
          Start-Sleep -Seconds 10
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          $ip = $ip.Trim()
          
          echo "tailscale_ip=$ip" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding UTF8

      - name: Display Connection Info
        shell: pwsh
        run: |
          $duration = ${{ fromJSON(github.event.inputs.session_duration) }}
          $hours = $duration
          $minutes = $hours * 60
          
          Write-Host "`n" + "="*60
          Write-Host "WINDOWS 10 RDP READY"
          Write-Host "="*60
          Write-Host "IP Address: ${{ steps.tailscale.outputs.tailscale_ip }}"
          Write-Host "Username: ${{ github.event.inputs.rdp_username }}"
          Write-Host "Password: ${{ steps.create_user.outputs.rdp_password }}"
          Write-Host "-"*60
          Write-Host "Session Duration: $hours hours"
          Write-Host "Timeout: $minutes minutes"
          Write-Host "="*60
          
          # الحفاظ على الجلسة نشطة
          $startTime = Get-Date
          $endTime = $startTime.AddHours($hours)
          
          while ((Get-Date) -lt $endTime) {
              $remaining = $endTime - (Get-Date)
              Write-Host "[$(Get-Date)] Session active. Remaining: $($remaining.ToString('hh\:mm\:ss'))"
              Start-Sleep -Seconds 60
          }
          
          Write-Host "Session timeout reached. Shutting down..."
